#!/bin/bash

# Colores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

NAMESPACE="odoo"
DEPLOYMENT="odoo"

function get_pod() {
    kubectl get pod -n $NAMESPACE -l app=odoo -o jsonpath="{.items[0].metadata.name}"
}

function show_help() {
    echo -e "${BLUE}Odoo Control Tool (odooctl)${NC}"
    echo "Uso: ./odooctl [comando]"
    echo ""
    echo "Comandos:"
    echo -e "  ${GREEN}logs${NC} [-f]       Ver logs (a√±ade -f para ver en tiempo real)"
    echo -e "  ${GREEN}restart${NC}        Reiniciar Odoo suavemente"
    echo -e "  ${GREEN}shell${NC}          Entrar a la terminal del contenedor"
    echo -e "  ${GREEN}update <mod>${NC}   Actualizar un m√≥dulo espec√≠fico (ej: sale,account)"
    echo -e "  ${GREEN}status${NC}         Ver estado de los pods"
    echo -e "  ${GREEN}psql${NC}           Entrar a la base de datos (Postgres console)"
    echo -e "  ${GREEN}oca-install${NC}    Descargar repositorios comunes de OCA"
    echo ""
}

case "$1" in
    logs)
        POD=$(get_pod)
        echo -e "${BLUE}üìú Mostrando logs de $POD...${NC}"
        if [ "$2" == "-f" ]; then
            kubectl logs -f $POD -n $NAMESPACE
        else
            kubectl logs $POD -n $NAMESPACE
        fi
        ;;
    restart)
        echo -e "${BLUE}üîÑ Reiniciando Odoo...${NC}"
        kubectl rollout restart deployment $DEPLOYMENT -n $NAMESPACE
        echo -e "${GREEN}‚úÖ Reinicio solicitado. Usa './odooctl status' para ver progreso.${NC}"
        ;;
    shell)
        POD=$(get_pod)
        echo -e "${BLUE}üêö Entrando a $POD...${NC}"
        kubectl exec -it $POD -n $NAMESPACE -- /bin/bash
        ;;
    status)
        echo -e "${BLUE}üìä Estado del Cluster:${NC}"
        kubectl get pods -n $NAMESPACE
        kubectl get modules -A 2>/dev/null || true # Si tienes metricas
        ;;
    update)
        if [ -z "$2" ]; then
            echo -e "${RED}Error: Debes especificar el m√≥dulo a actualizar.${NC}"
            echo "Ejemplo: ./odooctl update account"
            exit 1
        fi
        POD=$(get_pod)
        echo -e "${BLUE}üöÄ Actualizando m√≥dulo: $2...${NC}"
        # Truco: Ejecutamos el comando de actualizaci√≥n en un proceso paralelo dentro del pod o reiniciamos con flag
        # En K8s prod, lo mejor es entrar y ejecutar, o usar un Job.
        # Para hacerlo facil: Entramos y corremos odoo-bin shell no es ideal.
        # La forma Correcta PRO: Editar el despliegue para forzar update o reiniciar.
        # Pero eso es lento.
        # Comandos directos:
        kubectl exec -it $POD -n $NAMESPACE -- odoo -u $2 --stop-after-init
        ;;
    psql)
        # Buscar pod de postgres
        PG_POD=$(kubectl get pod -n postgresql -l app=postgresql -o jsonpath="{.items[0].metadata.name}")
        echo -e "${BLUE}üêò Entrando a Postgres ($PG_POD)...${NC}"
        kubectl exec -it $PG_POD -n postgresql -- psql -U odoo -d postgres
        ;;
    oca-install)
        # Ejecutar script helper si existe
        if [ -f "./scripts/install_oca.sh" ]; then
            ./scripts/install_oca.sh
        else
            echo "Script install_oca.sh no encontrado."
        fi
        ;;
    *)
        show_help
        ;;
esac
